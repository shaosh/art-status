<link rel="import" href="app-main-header.html">
<link rel="import" href="app-main-body.html">
<link rel="import" href="job-card.html">

<dom-module id="app-drawer-panel">
  <style>
    paper-tab{
      background: #5E6FC7;
      color:#fff;
    }
    
    :host{
      --paper-tabs-selection-bar-color: #7EC1F4;
    }
    
    #newjob{
      padding: 10px 20px;
      text-align: center;
      background-color: #F2FD8E;
      display: none;
    }
    
    .drawer{
      box-sizing:content-box;
      border-right: #132584 1px solid;
    }
    
    job-card{
      cursor: pointer;
    }

    .content{
      width:100%;
      height:auto;
    }
    
  </style>
  
  <template>
    <paper-drawer-panel drawer-width="400px">
      <paper-header-panel drawer mode="standard" class="drawer">
        <div class="paper-header">
          <paper-tabs selected="0" noink selected="{{leftTab}}">
            <paper-tab>
              <paper-menu-button>
                <paper-button class="dropdown-trigger">
                  <span>ALL (<span>{{jobs.length}}</span>)</span>
                  <iron-icon icon="expand-more"></iron-icon>
                </paper-button>
                <!--<paper-menu class="dropdown-content" selected="{{selectedIndex}}">-->
                <!--  <template is="dom-repeat" items="[[companies]]">-->
                <!--    <paper-item>[[item.name]]</paper-item>-->
                <!--  </template>-->
                <!--</paper-menu>-->
              </paper-menu-button>
            </paper-tab>            
            <paper-tab>MINE</paper-tab>
            <!-- <paper-tab>UNASSIGNED</paper-tab> -->
          </paper-tabs>
          <div id="newjob"><a href="#">You have <span>{{updateNum}}</span> new jobs.</a></div>
        </div>
        <template is="dom-repeat" items="{{jobs}}" sort="sortJob">
          <job-card job="{{item}}" on-click="selectJob"></job-card>
        </template>
      </paper-header-panel>
      <paper-header-panel main mode="standard">
        <div class="paper-header">
          <app-main-header job="{{selectedJob}}" tab="{{selectedTab}}"></app-main-header>
        </div>
        <div class="content">
          <app-main-body job="{{selectedJob}}" tab="{{selectedTab}}" users="{{users}}" jobs="{{jobs}}"></app-main-body>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  
  <script>
    Polymer({
      is: 'app-drawer-panel',

      ready: function(){
        var interval = 30000,
            that = this;
        setInterval(function(){that.getUpdateNum(localStorage.userId)}, interval);
      },

      getUpdateNum: function(userid){        
        var that = this;
        var options = {
          url: JOBREFRESH_URL,
          headers: HEADER,
          method: 'POST',
          json: true,
          body: {
           
          }
        };
        console.log('options', options)
        request(options, function(error, response, body){
          console.log(response, body)
          if(!error && response.statusCode === 200){
            if(!!body && !!body.count){
              that.updateNum = body.count;
              if(body.count > 0){
                that.$.newjob.style.display = 'block';
              }
              else{
                that.$.newjob.style.display = 'none';
              }
            }
          }
          else{
            outputError(!!error ? 'GetUpdateNum Error' + error : response.statusCode);
          }
        });        
      },

      attached: function(){
        this.addSelectedClass(this.selectedJob, null);
      },

      selectJob: function(e){
        var card = Polymer.dom(e).localTarget.childNodes[1];
        if(card.classList.contains('selected')){
          return;
        }
        
        this.unselectPrevJob();
        card.toggleClass('selected');
        this.selectedJob = e.model.item;
        this.selectedTab = 0;
        window.location.hash = '#/' + this.selectedCompany.company + '/' + this.selectedJob.jobId;     
      },      

      sortJob: function(a, b){
        return moment(b.updatedAt).diff(moment(a.updatedAt));
      },

      addSelectedClass: function(newValue, oldValue){
        var jobcards = Polymer.dom(this.root).querySelectorAll('job-card');
        if(typeof jobcards === 'undefined' || jobcards.length === 0){
          return;
        }
        
        for(var i = 0; i < jobcards.length; i++){
          var idSpan = Polymer.dom(jobcards[i].childNodes[1]).querySelector('.jobid');
          if(newValue.jobId === idSpan.getAttribute('data-jobid')){
            if(jobcards[i].childNodes[1].classList.contains('selected')){
            }
            else{
              this.unselectPrevJob();
              jobcards[i].childNodes[1].toggleClass('selected');              
            }
            return;
          }
        }
        this.unselectPrevJob();
        jobcards[0].childNodes[1].toggleClass('selected');
      },

      unselectPrevJob: function(){
        var prevSelected = Polymer.dom(this.root).querySelectorAll('job-card');
        if(prevSelected.length > 0){
          prevSelected.map(function(jobcard){
            jobcard.childNodes[1].toggleClass('selected', false);
          });
        }
      },      

      leftTabObserver: function(newValue, oldValue){
        if(!!newValue && !!oldValue ){
          if(newValue === LEFTTAB.ALL){

          }
          else{

          }
        }
      },

      properties: {
        jobs:{
          type: Array,
          notify: true
        },
        selectedJob: {
          type: Object,
          notify: true,
          observer: 'addSelectedClass'
        },
        selectedTab: {
          type: String,
          notify: true
        },
        leftTab: {
          type: String,
          notify: true,
          observer: 'leftTabObserver',
          value: '0'
        },
        updateNum: {
          type: Number,
          notify: true,
          value: 0
        },
        users: {
          type: Array,
          notify: true
        },
        companies: {
          type: Array,
          notify: true
        }
      }
    });
  </script>
</dom-module>